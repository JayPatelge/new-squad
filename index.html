<!DOCTYPE html>
<html>
<head>
    <title>Select Option for CARDS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        img {
            max-width: 100%; /* Ensure image scales to viewport width */
            height: auto; /* Maintain aspect ratio */
            margin: 20px 0;
            border: 2px solid #ccc;
            border-radius: 10px;
            display: none; /* Initially hide image */
        }
        .title {
            font-size: calc(20px + 2vw); /* Dynamically scale font size */
            text-align: center;
            margin-top: 20px;
        }
        .large-button {
            padding: calc(12px + 1vw) calc(40px + 2vw); /* Scale button size */
            font-size: calc(16px + 1vw); /* Scale font size */
            border-radius: 10px;
            border: 3px solid black;
            background-color: skyblue;
            cursor: pointer;
        }
        .large-button.selected {
            background-color: gray; /* Highlight selected button */
        }
        #submit-button {
            display: none; /* Hide submit button initially */
        }
    </style>
</head>
<body>
    <div class="title">Select Option for CARDS</div>
    <img id="task-image" alt="Image">
    <div id="text" class="title" style="font-size: calc(16px + 1vw); margin: 20px 0;">Waiting for task...</div>
    <div id="category-options"></div>
    <button id="submit-button" disabled class="large-button">Submit</button>
    <audio id="notification-sound" src="/static/John-Cena-My-Time-Is-Now-(TrendyBeatz.com).mp3" type="audio/mpeg"></audio>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script>
        const socket = io();
        let selectedCategory = null;
        const notificationSound = document.getElementById('notification-sound');
        const taskImage = document.getElementById('task-image');
        const textElement = document.getElementById('text');
        const categoryOptions = document.getElementById('category-options');
        const submitButton = document.getElementById('submit-button');

        // Function to create dynamic buttons
        function createButton(category) {
            const button = document.createElement('button');
            button.textContent = category;
            button.className = 'large-button';
            button.addEventListener('click', () => {
                // Reset previous selection
                if (selectedCategory) {
                    document.querySelector('#category-options button.selected')?.classList.remove('selected');
                }
                selectedCategory = category;
                button.classList.add('selected'); // Highlight selected button
                submitButton.disabled = false;
                submitButton.style.display = 'block'; // Show submit button
            });
            return button;
        }

        // Fetch task and update UI
        function fetchTask() {
            fetch('/get_task')
                .then(response => response.json())
                .then(data => {
                    console.log('Task Data:', data); // Debugging output

                    if (data.has_new_task) {
                        taskImage.style.display = 'block'; // Show image
                        taskImage.src = data.image_path;
                        textElement.textContent = data.text;

                        categoryOptions.innerHTML = ''; // Clear previous buttons
                        data.categories.forEach(category => {
                            categoryOptions.appendChild(createButton(category));
                        });

                        notificationSound.play(); // Play notification sound
                    } else {
                        taskImage.style.display = 'none'; // Hide image
                        textElement.textContent = 'Waiting for task...';
                        categoryOptions.innerHTML = ''; // Clear previous buttons
                        submitButton.style.display = 'none'; // Hide submit button
                    }
                })
                .catch(error => {
                    console.error('Error fetching task:', error);
                });
        }

        // Submit selected category
        submitButton.addEventListener('click', () => {
            if (selectedCategory) {
                socket.emit('category_selected', { category: selectedCategory });
                selectedCategory = null;
                submitButton.disabled = true;
                submitButton.style.display = 'none'; // Hide submit button
                socket.emit('stop_server');
            }
        });

        // Listen for category updates
        socket.on('category_updated', () => {
            fetchTask(); // Refresh UI on updates
        });

        // Initial fetch
        fetchTask();
    </script>
</body>
</html>
